name: CI Pipeline de Calidad y Pruebas

on:
  push:
    branches:
      - main  # Se activa al hacer push a 'main'
      - dev
  pull_request:
    branches:
      - main  # Se activa para cualquier PR dirigida a 'main'

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # Ejecuta el trabajo en un entorno Linux
    
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5433:5432
        
      
    env:
        DATABASE_URL: postgresql://test_user:test_pass@localhost:5433/test_db
    steps:
    - name: ‚¨áÔ∏è Checkout del C√≥digo
      uses: actions/checkout@v4

    - name: üêç Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'  # Define la versi√≥n de Python

    - name: ‚ö° Instalar uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: üì• Instalar Dependencias
      run: |
        cd Backend
        uv sync  # Instala las dependencias de producci√≥n y desarrollo (incluyendo tests y linters)
        
    - name: üìê Formateo con ruff (Verificaci√≥n)
      # Ejecuta ruff format solo para verificar si hay cambios de formato pendientes.
      # Si hay cambios no guardados, el CI falla y el desarrollador debe aplicar el formato localmente.
      run: |
        cd Backend
        uv run ruff format --check --diff .

    - name: ‚ö° Linting R√°pido con ruff
      # Ruff es un linter extremadamente r√°pido que reemplaza a flake8 y otros.
      run: |
        cd Backend
        uv run ruff check .

    - name: üîé Verificaci√≥n de Tipos con mypy
      # mypy es crucial para FastAPI ya que asegura la consistencia de tipos.
      run: |
        cd Backend
        uv run mypy .

    - name: üß™ Ejecutar Pruebas con pytest
      # Ejecuta todas las pruebas unitarias y de integraci√≥n.
      # Se asume que las dependencias de la DB de prueba (si las hay) est√°n configuradas.
      
      run: |
        cd Backend
        uv run pytest tests/integration --cov=. --cov-report=term-missing --cov-fail-under=80
        
        
    # --- Etapa opcional de Construcci√≥n de Docker (Fin de CI) ---

    - name: üê≥ Construir Imagen Docker (Artefacto de CI)
      # Construye la imagen solo para verificar que el Dockerfile funciona con el c√≥digo actual.
      run: |
        docker build -f Backend/Dockerfile -t fastapi-app:latest .