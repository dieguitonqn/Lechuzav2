name: CI Pipeline de Calidad y Pruebas

on:
  push:
    branches:
      - main  # Se activa al hacer push a 'main'
      - dev
  pull_request:
    branches:
      - main  # Se activa para cualquier PR dirigida a 'main'

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # Ejecuta el trabajo en un entorno Linux
    
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U test_user -d test_db -h 127.0.0.1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
        
      
    env:
        DATABASE_URL: postgresql://test_user:test_pass@localhost:5433/test_db
    steps:
    - name: â¬‡ï¸ Checkout del CÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'  # Define la versiÃ³n de Python

    - name: âš¡ Instalar uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: ğŸ“¥ Instalar Dependencias
      run: |
        cd Backend
        uv sync  # Instala las dependencias de producciÃ³n y desarrollo (incluyendo tests y linters)
        
    - name: ğŸ“ Formateo con ruff (VerificaciÃ³n)
      # Ejecuta ruff format solo para verificar si hay cambios de formato pendientes.
      # Si hay cambios no guardados, el CI falla y el desarrollador debe aplicar el formato localmente.
      run: |
        cd Backend
        uv run ruff format --check --diff .

    - name: âš¡ Linting RÃ¡pido con ruff
      # Ruff es un linter extremadamente rÃ¡pido que reemplaza a flake8 y otros.
      run: |
        cd Backend
        uv run ruff check .

    - name: ğŸ” VerificaciÃ³n de Tipos con mypy
      # mypy es crucial para FastAPI ya que asegura la consistencia de tipos.
      run: |
        cd Backend
        uv run mypy .

    - name: â³ Esperar disponibilidad de PostgreSQL
      # Espera activa hasta que PostgreSQL estÃ© listo para aceptar conexiones
      run: |
        echo "Esperando a que PostgreSQL estÃ© listo..."
        for i in {1..30}; do
          if pg_isready -h localhost -p 5433 -U test_user -d test_db > /dev/null 2>&1; then
            echo "âœ… PostgreSQL estÃ¡ listo"
            exit 0
          fi
          echo "Intento $i/30: PostgreSQL aÃºn no estÃ¡ listo..."
          sleep 2
        done
        echo "âŒ PostgreSQL no respondiÃ³ a tiempo"
        exit 1

    - name: ğŸ§ª Ejecutar Pruebas con pytest
      # Ejecuta todas las pruebas unitarias y de integraciÃ³n.
      # Se asume que las dependencias de la DB de prueba (si las hay) estÃ¡n configuradas.
      
      run: |
        cd Backend
        uv run pytest tests/integration --cov=. --cov-report=term-missing --cov-fail-under=80
        
        
    # --- Etapa opcional de ConstrucciÃ³n de Docker (Fin de CI) ---

    - name: ğŸ³ Construir Imagen Docker (Artefacto de CI)
      # Construye la imagen solo para verificar que el Dockerfile funciona con el cÃ³digo actual.
      run: |
        docker build -f Backend/Dockerfile -t fastapi-app:latest .