name: CI Pipeline de Calidad y Pruebas

on:
  push:
    branches:
      - main  # Se activa al hacer push a 'main'
  pull_request:
    branches:
      - main  # Se activa para cualquier PR dirigida a 'main'

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # Ejecuta el trabajo en un entorno Linux

    steps:
    - name: â¬‡ï¸ Checkout del CÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'  # Define la versiÃ³n de Python

    - name: âš¡ Instalar uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: ğŸ“¥ Instalar Dependencias
      run: |
        cd Backend
        uv sync  # Instala las dependencias de producciÃ³n y desarrollo (incluyendo tests y linters)
        
    - name: ğŸ“ Formateo con autopep8 (VerificaciÃ³n)
      # Ejecuta autopep8 solo para verificar si hay cambios de formato pendientes.
      # Si hay cambios no guardados, el CI falla y el desarrollador debe aplicar el formato localmente.
      run: |
        cd Backend
        uv run autopep8 --exit-code --diff --recursive .

    - name: âš¡ Linting RÃ¡pido con ruff
      # Ruff es un linter extremadamente rÃ¡pido que reemplaza a flake8 y otros.
      run: |
        cd Backend
        uv run ruff check .

    - name: ğŸ” VerificaciÃ³n de Tipos con mypy
      # mypy es crucial para FastAPI ya que asegura la consistencia de tipos.
      run: |
        cd Backend
        uv run mypy .

    - name: ğŸ§ª Ejecutar Pruebas con pytest
      # Ejecuta todas las pruebas unitarias y de integraciÃ³n.
      # Se asume que las dependencias de la DB de prueba (si las hay) estÃ¡n configuradas.
      run: |
        cd Backend
        uv run pytest
        
    # --- Etapa opcional de ConstrucciÃ³n de Docker (Fin de CI) ---

    - name: ğŸ³ Construir Imagen Docker (Artefacto de CI)
      # Construye la imagen solo para verificar que el Dockerfile funciona con el cÃ³digo actual.
      run: |
        docker build -t fastapi-app:latest .